name: Building and Testing the app

on: push

jobs: 
  build:
     runs-on: ubuntu-latest
     steps:
      - name: checkout code
        uses: actions/checkout@v4
      - name: use nodejs
        uses: actions/setup-node@v4
        with: 
          node-version: '20.x'
      - run: npm cache clean --force
      - run: npm install
      - run: npm run build
      - run: |   # pipe symbol is needed for multi line string
          echo "current directory before changing"
          pwd
          echo "Listing contents of directory"
          ls -la
          echo "Listing contents of dist directory"
          cd dist
          ls -la

  test:
    needs: build # this means the test job will run only after the build job has succeeded
    runs-on: ubuntu-latest
    steps:
      - name: checkout repo
        uses: actions/checkout@v4
      - name: use node
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
      - run : npm cache clean --force
      - run : npm install
      - run : npm test

  deploy:
    needs: test # only after test job completes, the deploy job will start
    runs-on: ubuntu-latest

# how smoothly the workflow can interact with the github repo
    permissions:
       contents: write
       pages: write
       id-token: write

# target environment we created in the repo settings. We have also included the deployment url
    environment:
      name: production
      url: ${{steps.deployment.outputs.page_url}}

    steps:
      - name: checkout repo
        uses: actions/checkout@v4
        with:
          token : ${{ secrets.GITHUB_TOKEN }}  # this time we are not just reading the repo. we are writing to it too. Thus github token is needed

      - name: use node
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
      
      - name: configure github pages
        uses: actions/configure-pages@v4
        # with:
        #   static_site_generator: angular

      - run: npm cache clean --force
      - run : npm install
      - run : npm run build

      - name: upload dist
        uses: actions/upload-pages-artifact@v3
        with:
         path: ./dist

      - name: deploy to github pages
        id: deployment
        uses: actions/deploy-pages@v4  # deploy the dist to github pages
      

         


        
